# Dockerfile for Airgap Go Testing
# Provides Go toolchain, gotestsum, OpenTofu, Ansible, and AWS CLI for test execution

ARG TOFU_VERSION=1.10.7
ARG GOTESTSUM_VERSION=v1.13.0

FROM --platform=linux/amd64 golang:1.25-alpine3.22

ARG TOFU_VERSION
ARG GOTESTSUM_VERSION

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    python3 \
    py3-pip \
    ca-certificates

# Install Ansible and AWS CLI
RUN pip3 install --no-cache-dir --break-system-packages ansible awscli

# Install OpenTofu with checksum verification
RUN curl -Lo /tmp/tofu_${TOFU_VERSION}_linux_amd64.tar.gz "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.tar.gz" \
    && curl -Lo /tmp/tofu_SHA256SUMS "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_SHA256SUMS" \
    && cd /tmp && grep "tofu_${TOFU_VERSION}_linux_amd64.tar.gz$" tofu_SHA256SUMS | sha256sum -c - \
    && tar -xzf /tmp/tofu_${TOFU_VERSION}_linux_amd64.tar.gz -C /usr/local/bin/ \
    && rm /tmp/tofu_${TOFU_VERSION}_linux_amd64.tar.gz /tmp/tofu_SHA256SUMS \
    && chmod +x /usr/local/bin/tofu

# Install gotestsum (pinned version for reproducible builds)
ENV GOBIN=/usr/local/bin
RUN go install gotest.tools/gotestsum@${GOTESTSUM_VERSION}
ENV GOBIN=

# Set Ansible config to the consolidated ansible.cfg in qa-infra-automation
ENV ANSIBLE_CONFIG=/workspace/qa-infra-automation/ansible/ansible.cfg

# Create working directory
WORKDIR /workspace

# Verify installations
RUN tofu version && \
    ansible --version && \
    aws --version && \
    go version && \
    gotestsum --version

# Default to sh shell (compatible with docker run sh -c)
CMD ["/bin/sh"]
