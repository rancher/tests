# Dockerfile for Airgap Go Testing
# Extends infra tools with Go toolchain and gotestsum for test execution

# Pin to specific version for supply chain security
ARG TOFU_VERSION=1.10.7
ARG GO_VERSION=1.25.5
ARG GOTESTUM_VERSION=1.13.0

FROM --platform=linux/amd64 alpine:3.22

ARG TOFU_VERSION
ARG GO_VERSION
ARG GOTESTUM_VERSION

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    python3 \
    py3-pip \
    ca-certificates \
    ansible \
    && rm -rf /var/cache/apk/*

# Install Go toolchain
RUN curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tgz \
    && tar -C /usr/local -xzf /tmp/go.tgz \
    && rm /tmp/go.tgz \
    && ln -s /usr/local/go/bin/go /usr/local/bin/go \
    && ln -s /usr/local/go/bin/gofmt /usr/local/bin/gofmt

# Install OpenTofu
RUN curl -Lo /tmp/tofu.tar.gz "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.tar.gz" \
    && tar -xzf /tmp/tofu.tar.gz -C /usr/local/bin/ \
    && rm /tmp/tofu.tar.gz \
    && chmod +x /usr/local/bin/tofu

# Install AWS CLI
RUN pip3 install --no-cache-dir --break-system-packages awscli

# Install gotestsum for JUnit reporting
ENV GOBIN=/usr/local/bin
RUN go install gotest.tools/gotestsum@${GOTESTUM_VERSION}
ENV GOBIN=

# Create working directory
WORKDIR /workspace

# Verify installations
RUN tofu version && \
    ansible --version && \
    aws --version && \
    go version && \
    gotestsum --version

# Default to sh shell (compatible with alpine and docker run sh -c)
CMD ["/bin/sh"]
