# Lean Dockerfile for Infrastructure Operations
# Contains only essentials for running Ansible, Tofu, and AWS

ARG TOFU_VERSION=1.10.7

FROM --platform=linux/amd64 alpine:3.22

ARG TOFU_VERSION

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    python3 \
    py3-pip \
    ca-certificates \
    ansible \
    && rm -rf /var/cache/apk/*

# Install OpenTofu
RUN curl -Lo /tmp/tofu.tar.gz "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.tar.gz" \
    && tar -xzf /tmp/tofu.tar.gz -C /usr/local/bin/ \
    && rm /tmp/tofu.tar.gz \
    && chmod +x /usr/local/bin/tofu

# Install AWS CLI
RUN pip3 install --no-cache-dir --break-system-packages awscli

# Set Ansible config to the consolidated ansible.cfg in qa-infra-automation.
# ANSIBLE_ROLES_PATH is set explicitly because roles_path in ansible.cfg resolves
# relative to the CWD at invocation time, not the ansible.cfg directory.
ENV ANSIBLE_CONFIG=/workspace/qa-infra-automation/ansible/ansible.cfg \
    ANSIBLE_ROLES_PATH=/workspace/qa-infra-automation/ansible/roles

# Create working directory
WORKDIR /workspace

# Verify installations
RUN tofu version && \
    ansible --version && \
    aws --version

# Default to sh shell (compatible with alpine and docker run sh -c)
CMD ["/bin/sh"]
