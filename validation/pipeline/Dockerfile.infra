# Lean Dockerfile for Infrastructure Operations
# Contains only essentials for running Ansible and Tofu

ARG TOFU_VERSION=1.10.7
ARG ANSIBLE_VERSION=3.14

FROM alpine:3.22

ARG TOFU_VERSION
ARG ANSIBLE_VERSION

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    python3 \
    py3-pip \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Install OpenTofu
RUN curl -Lo /tmp/tofu.tar.gz "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.tar.gz" \
    && tar -xzf /tmp/tofu.tar.gz -C /usr/local/bin/ \
    && rm /tmp/tofu.tar.gz \
    && chmod +x /usr/local/bin/tofu

# Install Ansible
RUN pip3 install --no-cache-dir --break-system-packages \
    ansible==${ANSIBLE_VERSION} \
    boto3 \
    botocore

# Install AWS CLI
RUN pip3 install --no-cache-dir --break-system-packages awscli

# Create working directory
WORKDIR /workspace

# Verify installations
RUN tofu version && \
    ansible --version && \
    aws --version

# Set entrypoint
ENTRYPOINT ["/bin/bash"]
