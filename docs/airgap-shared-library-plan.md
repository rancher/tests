# Airgap Pipeline Helper Inventory

## Objective
Provide a definitive catalog of helper functions used by the validation airgap pipelines covering library Groovy scripts and the specialized Jenkinsfiles. Functions are grouped by responsibility: checkout, environment preparation, tofu/ansible execution, and cleanup/verification.

## Summary Table

| Component | Checkout | Environment Preparation | Tofu / Ansible Execution | Cleanup & Verification |
|-----------|----------|--------------------------|--------------------------|------------------------|
| [`airgap.groovy`](validation/pipeline/ci/airgap.groovy:1) | [`checkoutRepositories`](validation/pipeline/ci/airgap.groovy:52) | [`configureEnv`](validation/pipeline/ci/airgap.groovy:10), [`prepareInfra`](validation/pipeline/ci/airgap.groovy:17), [`setupEnv`](validation/pipeline/ci/airgap.groovy:30), [`buildDockerImage`](validation/pipeline/ci/airgap.groovy:249), [`createSharedVolume`](validation/pipeline/ci/airgap.groovy:274), [`ensureSSHKeysInContainer`](validation/pipeline/ci/airgap.groovy:279), [`generateTofuConfiguration`](validation/pipeline/ci/airgap.groovy:523), [`configureDestructionEnvironment`](validation/pipeline/ci/airgap.groovy:568), [`generateDestructionEnvironmentFile`](validation/pipeline/ci/airgap.groovy:577), [`ensureDestructionSSHKeys`](validation/pipeline/ci/airgap.groovy:635) | [`deployInfrastructure`](validation/pipeline/ci/airgap.groovy:101), [`prepareAnsibleEnv`](validation/pipeline/ci/airgap.groovy:153), [`deployRKE2`](validation/pipeline/ci/airgap.groovy:187), [`deployRancher`](validation/pipeline/ci/airgap.groovy:214), [`archiveCommonArtifacts`](validation/pipeline/ci/airgap.groovy:241), [`extractArtifactsFromDockerVolume`](validation/pipeline/ci/airgap.groovy:367), [`generateDeploymentSummary`](validation/pipeline/ci/airgap.groovy:480) | [`cleanupContainersAndVolumes`](validation/pipeline/ci/airgap.groovy:337), [`shellQuote`](validation/pipeline/ci/airgap.groovy:652), [`mergeCleanupOptions`](validation/pipeline/ci/airgap.groovy:663), [`buildCleanupArguments`](validation/pipeline/ci/airgap.groovy:695), [`runCleanupWorkflow`](validation/pipeline/ci/airgap.groovy:715), [`verifyCleanupState`](validation/pipeline/ci/airgap.groovy:755), [`destroyInfrastructure`](validation/pipeline/ci/airgap.groovy:793), [`archiveDestructionResults`](validation/pipeline/ci/airgap.groovy:808), [`archiveDestructionFailureArtifacts`](validation/pipeline/ci/airgap.groovy:825), [`cleanupS3WorkspaceDirectory`](validation/pipeline/ci/airgap.groovy:861), [`archiveArtifactsByType`](validation/pipeline/ci/airgap.groovy:932), [`archiveFailureArtifactsByType`](validation/pipeline/ci/airgap.groovy:948), [`archiveBuildArtifacts`](validation/pipeline/ci/airgap.groovy:963), [`executeInfrastructureCleanup`](validation/pipeline/ci/airgap.groovy:976), [`logInfo`](validation/pipeline/ci/airgap.groovy:911), [`logWarning`](validation/pipeline/ci/airgap.groovy:912), [`logError`](validation/pipeline/ci/airgap.groovy:913), [`getArtifactDefinitions`](validation/pipeline/ci/airgap.groovy:917) |
| [`docker_helper.groovy`](validation/pipeline/ci/docker_helper.groovy:1) | – | [`DockerExecutionHelper`](validation/pipeline/ci/docker_helper.groovy:5), [`executeScriptInContainer`](validation/pipeline/ci/docker_helper.groovy:13), [`buildWorkspaceEnvFlags`](validation/pipeline/ci/docker_helper.groovy:27), [`prepareEnvironmentVariables`](validation/pipeline/ci/docker_helper.groovy:31), [`prepareDockerCommand`](validation/pipeline/ci/docker_helper.groovy:52), [`prepareFallbackDockerCommand`](validation/pipeline/ci/docker_helper.groovy:172), [`collectVolumeMounts`](validation/pipeline/ci/docker_helper.groovy:207), [`collectFallbackVolumeMounts`](validation/pipeline/ci/docker_helper.groovy:249), [`resolveInventoryMount`](validation/pipeline/ci/docker_helper.groovy:305), [`credentialsBindings`](validation/pipeline/ci/docker_helper.groovy:163), [`writeCredentialEnvironmentFile`](validation/pipeline/ci/docker_helper.groovy:479) | [`executeDockerCommand`](validation/pipeline/ci/docker_helper.groovy:80), [`attemptPrimaryExecution`](validation/pipeline/ci/docker_helper.groovy:105), [`attemptFallbackExecution`](validation/pipeline/ci/docker_helper.groovy:119), [`addCredentialEnvFile`](validation/pipeline/ci/docker_helper.groovy:503), [`extractDirectEnvironmentVariables`](validation/pipeline/ci/docker_helper.groovy:432) | [`cleanupExecutionArtifacts`](validation/pipeline/ci/docker_helper.groovy:146), [`cleanupDanglingContainers`](validation/pipeline/ci/docker_helper.groovy:360), [`maskSensitiveData`](validation/pipeline/ci/docker_helper.groovy:377), [`provideDockerDiagnostics`](validation/pipeline/ci/docker_helper.groovy:407), [`validateDockerEnvironment`](validation/pipeline/ci/docker_helper.groovy:321), [`validateDockerImage`](validation/pipeline/ci/docker_helper.groovy:341) |
| [`helpers.groovy`](validation/pipeline/ci/helpers.groovy:1) | – | [`readParamsYaml`](validation/pipeline/ci/helpers.groovy:3), [`createCredentialEnvironmentFile`](validation/pipeline/ci/helpers.groovy:16), [`addCredentialEnvFileToDockerCommand`](validation/pipeline/ci/helpers.groovy:38), [`buildDockerImage`](validation/pipeline/ci/helpers.groovy:157), [`createSharedVolume`](validation/pipeline/ci/helpers.groovy:179) | [`executeScriptInContainer`](validation/pipeline/ci/helpers.groovy:62), [`executeInContainer`](validation/pipeline/ci/helpers.groovy:105) | [`cleanupContainersAndVolumes`](validation/pipeline/ci/helpers.groovy:140) |
| [`Jenkinsfile.setup.airgap.rke2`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1) | [`ciHelpers`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:39), [`ciAirgap`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:55), [`dockerHelper`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:74) | [`configureEnvironmentComplete`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:196), [`readAndValidateAnsibleVariables`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:227), [`setupSSHKeysSecure`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:241), [`generateEnvironmentFileComplete`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:287), [`extractAWSVariablesFromTerraformConfig`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:336), [`getCredentialsList`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:815), [`getShortJobName`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:828), [`cleanupSSHKeys`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:841), [`buildDockerImage`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:887), [`createSharedVolume`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:896), [`ensureSSHKeysInContainer`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:905) | [`runValidationHelper`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:153), [`validateParameters`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:741), [`validateRequiredVariables`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:763), [`validateSensitiveDataHandling`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:787), [`archiveArtifactsByType`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1021), [`archiveFailureArtifactsByType`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1028), [`archiveBuildArtifacts`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1032), [`handleFailureCleanup`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1042), [`executeInfrastructureCleanup`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1079) | [`cleanupContainersAndVolumes`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:992), [`logInfo`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:721), [`logError`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:725), [`logWarning`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:729) |
| [`Jenkinsfile.destroy.airgap.rke2`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:1) | [`ciHelpers`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:332), [`ciAirgap`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:349), [`callLibraryMethod`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:365) | [`validateParameters`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:385), [`validateRequiredVariables`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:401), [`getShortJobName`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:421), [`getCredentialsList`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:430), [`getS3BucketName`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:477), [`getS3KeyPrefix`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:485), [`getS3BucketRegion`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:493), [`getAwsRegion`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:501) | [`archiveBuildArtifacts`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:437) | [`cleanupContainersAndVolumes`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:446), [`logInfo`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:457), [`logError`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:461), [`logWarning`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:465) |

## Observations
- The setup Jenkinsfile contains several guard rails (lazy loading, validation helpers, security hooks) that should migrate into the shared library so that jobs call higher-level orchestration helpers instead of maintaining local copies.
- Destruction pipeline helpers primarily coordinate shared library functions, suggesting most destruction logic is already abstracted; missing functions in the shared library should be added rather than redefined locally.
- Legacy functions in [`helpers.groovy`](validation/pipeline/ci/helpers.groovy:1) overlap with modern implementations in [`airgap.groovy`](validation/pipeline/ci/airgap.groovy:1) and [`docker_helper.groovy`](validation/pipeline/ci/docker_helper.groovy:1). Consolidation should deprecate the older versions after confirming no external jobs still source them.

## Next Steps
1. Confirm which helper duplicates (e.g., docker build/volume creation) can be deprecated and reference the modern equivalents.
2. Update Jenkinsfiles to rely more heavily on shared library entry points, minimizing inline logic.
3. Draft contribution plan to upstream validated helpers into `qa-jenkins-library`.

## Airgap Setup Shared Library Implementation Plan
1. **Inventory & Mapping** – Break down the existing `Jenkinsfile.setup.airgap.rke2` helpers into functional buckets (checkout, environment prep, deploy orchestration, cleanup). Map each to a prospective method on a new `AirgapSetupPipeline` class so feature parity is explicit up front.
2. **Shared Library Scaffolding** – In `qa-jenkins-library`, add `src/org/rancher/qa/airgap/AirgapSetupPipeline.groovy` plus a `vars/airgapSetup.groovy` facade modelled after the destroy pipeline. Seed the class with state handling, logging, and context initialization reused from `PipelineDefaults`.
3. **Stage-Oriented Method Porting** – Incrementally migrate major Jenkinsfile responsibilities into the new pipeline: repository checkout, environment/credential priming, container preparation, deploy stages (Tofu, Ansible, Rancher), artifact archiving, and failure cleanup. Reuse existing managers (`DockerManager`, `EnvironmentManager`, `ValidationManager`, `ArtifactManager`) where possible; add new manager capabilities only when gaps are found.
4. **Jenkinsfile Refactor** – Update `validation/pipeline/Jenkinsfile.setup.airgap.rke2` to initialize `airgapSetup.pipeline(this)`, delegate stage calls, and replace inline helpers with the shared library equivalents. Retain minimal orchestration (parameters, stages, logging) similar to the destroy Jenkinsfile.
5. **Regression & Coverage** – Run targeted Jenkins setup jobs (dry-run and live) against both the shared library branch and the updated Jenkinsfile to confirm functional parity. Add or update unit-style pipeline tests/examples in the library if available, and document any new inputs or environment expectations.
6. **Cleanup & Adoption** – Remove or slim down redundant helpers in `validation/pipeline/ci/*.groovy` once no longer referenced. Update documentation/readmes to point consumers at the new shared library entry points and coordinate PRs in both repositories for review and merge.
