# Airgap Pipeline Helper Inventory

## Objective
Provide a definitive catalog of helper functions used by the validation airgap pipelines covering library Groovy scripts and the specialized Jenkinsfiles. Functions are grouped by responsibility: checkout, environment preparation, tofu/ansible execution, and cleanup/verification.

## Summary Table

| Component | Checkout | Environment Preparation | Tofu / Ansible Execution | Cleanup & Verification |
|-----------|----------|--------------------------|--------------------------|------------------------|
| [DEPRECATED] `validation/pipeline/ci/airgap.groovy` | Moved to shared library | Use `qa-jenkins-library/src/org/rancher/qa/airgap/AirgapSetupPipeline.groovy` and `qa-jenkins-library/vars/airgapSetup.groovy` | Use `InfrastructureManager`, `ArtifactManager`, `DockerManager` in qa-jenkins-library | Use shared-library cleanup and artifact helpers |
| [DEPRECATED] `validation/pipeline/ci/docker_helper.groovy` | – | Replaced by `qa-jenkins-library/src/org/rancher/qa/airgap/DockerManager.groovy` | Replaced by shared library managers | Replaced by shared library managers |
| [DEPRECATED] `validation/pipeline/ci/helpers.groovy` | – | Superseded by shared library `EnvironmentManager`/`DockerManager` | Use shared library execution helpers | Use shared library cleanup |
| [`Jenkinsfile.setup.airgap.rke2`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1) | [`ciHelpers`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:39), [`ciAirgap`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:55), [`dockerHelper`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:74) | [`configureEnvironmentComplete`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:196), [`readAndValidateAnsibleVariables`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:227), [`setupSSHKeysSecure`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:241), [`generateEnvironmentFileComplete`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:287), [`extractAWSVariablesFromTerraformConfig`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:336), [`getCredentialsList`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:815), [`getShortJobName`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:828), [`cleanupSSHKeys`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:841), [`buildDockerImage`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:887), [`createSharedVolume`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:896), [`ensureSSHKeysInContainer`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:905) | [`runValidationHelper`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:153), [`validateParameters`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:741), [`validateRequiredVariables`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:763), [`validateSensitiveDataHandling`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:787), [`archiveArtifactsByType`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1021), [`archiveFailureArtifactsByType`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1028), [`archiveBuildArtifacts`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1032), [`handleFailureCleanup`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1042), [`executeInfrastructureCleanup`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:1079) | [`cleanupContainersAndVolumes`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:992), [`logInfo`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:721), [`logError`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:725), [`logWarning`](validation/pipeline/Jenkinsfile.setup.airgap.rke2:729) |
| [`Jenkinsfile.destroy.airgap.rke2`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:1) | [`ciHelpers`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:332), [`ciAirgap`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:349), [`callLibraryMethod`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:365) | [`validateParameters`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:385), [`validateRequiredVariables`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:401), [`getShortJobName`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:421), [`getCredentialsList`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:430), [`getS3BucketName`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:477), [`getS3KeyPrefix`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:485), [`getS3BucketRegion`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:493), [`getAwsRegion`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:501) | [`archiveBuildArtifacts`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:437) | [`cleanupContainersAndVolumes`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:446), [`logInfo`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:457), [`logError`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:461), [`logWarning`](validation/pipeline/Jenkinsfile.destroy.airgap.rke2:465) |

## Observations
- The setup Jenkinsfile contains several guard rails (lazy loading, validation helpers, security hooks) that should migrate into the shared library so that jobs call higher-level orchestration helpers instead of maintaining local copies.
- Destruction pipeline helpers primarily coordinate shared library functions, suggesting most destruction logic is already abstracted; missing functions in the shared library should be added rather than redefined locally.
- Legacy CI Groovy files under `validation/pipeline/ci/*.groovy` are now deprecated in favor of `qa-jenkins-library`. Plan to remove:
	- `validation/pipeline/ci/airgap.groovy`
	- `validation/pipeline/ci/docker_helper.groovy`
	- `validation/pipeline/ci/helpers.groovy`
	after confirming no remaining references.

## Next Steps
1. Confirm which helper duplicates (e.g., docker build/volume creation) can be deprecated and reference the modern equivalents.
2. Update Jenkinsfiles to rely more heavily on shared library entry points, minimizing inline logic.
3. Draft contribution plan to upstream validated helpers into `qa-jenkins-library`.

## Airgap Setup Shared Library Implementation Plan
1. **Inventory & Mapping** – Break down the existing `Jenkinsfile.setup.airgap.rke2` helpers into functional buckets (checkout, environment prep, deploy orchestration, cleanup). Map each to a prospective method on a new `AirgapSetupPipeline` class so feature parity is explicit up front.
2. **Shared Library Scaffolding** – Use `qa-jenkins-library` shared classes and vars:
	- `src/org/rancher/qa/airgap/AirgapSetupPipeline.groovy`
	- `src/org/rancher/qa/airgap/{DockerManager,InfrastructureManager,ArtifactManager,ValidationManager,EnvironmentManager}.groovy`
	- `vars/airgapSetup.groovy`, `vars/airgapDestroy.groovy`
	Seed pipeline state, logging, and context via `PipelineDefaults` in the library.
3. **Stage-Oriented Method Porting** – Incrementally migrate major Jenkinsfile responsibilities into the new pipeline: repository checkout, environment/credential priming, container preparation, deploy stages (Tofu, Ansible, Rancher), artifact archiving, and failure cleanup. Reuse existing managers (`DockerManager`, `EnvironmentManager`, `ValidationManager`, `ArtifactManager`) where possible; add new manager capabilities only when gaps are found.
4. **Jenkinsfile Refactor** – Update `validation/pipeline/Jenkinsfile.setup.airgap.rke2` to initialize `airgapSetup.pipeline(this)`, delegate stage calls, and replace inline helpers with the shared library equivalents. Retain minimal orchestration (parameters, stages, logging). Remove dependencies on `validation/pipeline/ci/*.groovy`.
5. **Regression & Coverage** – Run targeted Jenkins setup jobs (dry-run and live) against both the shared library branch and the updated Jenkinsfile to confirm functional parity. Add or update unit-style pipeline tests/examples in the library if available, and document any new inputs or environment expectations.
6. **Cleanup & Adoption** – Remove redundant helpers in `validation/pipeline/ci/*.groovy` once no longer referenced. Update documentation/readmes to point consumers at the new shared library entry points and coordinate PRs in both repositories for review and merge.

> Deprecation notice: The CI helper scripts under `validation/pipeline/ci/` have been superseded by `qa-jenkins-library`. Use the shared library entry points (`airgapSetup`, `airgapDestroy`) and managers (`DockerManager`, `InfrastructureManager`, `ArtifactManager`) instead. These files are slated for removal after downstream jobs are migrated.
